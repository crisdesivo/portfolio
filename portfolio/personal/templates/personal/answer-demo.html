{% extends 'personal/base.html' %}

{% block title %}Question Answering Demo{% endblock %}

{% block content %}
<style>
    #QAnswer {
        opacity: 0;
        animation: fadeIn 1s forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }
</style>

<div class="container mt-5">
    <div class="card">
        <div class="card-header">
            <h3>Question Answering Demo</h3>
        </div>
        <div class="card-body">
            <p class="card-text" id="QQuestion"><strong>Question:</strong> {{ last_question }}</p>
            <p class="card-text" id="QAnswer"><strong>Answer:</strong> {{ last_answer }}</p>
            <form id="questionForm" method="post" action="{% url 'ask_question' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="question">Ask me (Cristian) a Question:</label>
                    <input type="text" class="form-control" id="question" name="question" placeholder="Type your question here...">
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
            <div id="explanation" class="collapse">
                <div class="alert alert-warning" role="alert">This app uses an open source Large Language Model hosted on a Google Cloud Run server. It is run on 4 CPU cores. The model could be easily swapped by an OpenAI API which would return a response immediately (the drawback being it is a paid API). Alternatively, by hosting on a server with GPU you can expect 1-2 seconds per question.
                </div>
            </div>
            <!-- Progress bar -->
            <div id="progressContainer" class="mt-3" style="display: none; width: 100%;">
                <!-- progress bar label -->
                <p>Processing...</p>
                <!-- add a button to show section that explains why it takes so long -->
                <button type="button" class="btn btn-link" data-toggle="collapse" data-target="#explanation">Why does it take so long?</button>

                <div class="progress">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                        0%
                    </div>
                </div>
            </div>

            <div class="alert alert-success" id="success" role="alert" style="margin: 10px">
                <strong>Success!</strong> The answer is ready.
            </div>

            <div class="alert alert-danger" id="error" role="alert">
                <strong>Error:</strong> <p id="error-message"></p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.getElementById("questionForm");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const questionInput = document.getElementById("question");
        const submitButton = form.querySelector("button[type='submit']");
        const answerText = document.getElementById("QAnswer");
        const questionText = document.getElementById("QQuestion");
        const successAlert = document.getElementById("success");
        const errorAlert = document.getElementById("error");
        const errorMessage = document.getElementById("error-message");

        form.addEventListener("submit", function(event) {
            questionText.innerHTML = `<strong>Question:</strong> ${questionInput.value}`;
            answerText.innerHTML = "<strong>Answer:</strong> Processing...";
            // set the background of the answer to white
            answerText.style.backgroundColor = "white";
            event.preventDefault(); // Prevent default form submission

            // Show the progress bar and lock input
            progressContainer.style.display = "block";
            questionInput.disabled = true;
            submitButton.disabled = true;

            // Start the progress bar animation
            let progress = 0;
            const progressInterval = setInterval(function() {
                if (progress < 90) {
                    progress += 0.5;
                    progressBar.style.width = progress + "%";
                    progressBar.setAttribute("aria-valuenow", progress);
                    progressBar.textContent = Math.floor(progress) + "%";
                } else {
                    clearInterval(progressInterval); // Stop at 90%
                }
            }, 100);

            // Send the form data with AJAX
            const formData = new FormData(form);
            formData.append("question", questionInput.value);

            questionInput.value = ""; // Clear input
            successAlert.style.display = "none";
            errorAlert.style.display = "none";
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Ensures Django treats it as an AJAX request
                }
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval); // Stop progress bar animation
                progressBar.style.width = "100%";
                progressBar.setAttribute("aria-valuenow", 100);
                progressBar.textContent = "100%";

                // Update answer in the DOM
                if (data.error) {
                    // answerText.innerHTML = `<strong>Error:</strong> ${data.error}`;
                    errorMessage.textContent = data.error;
                    errorAlert.style.display = "block";
                } else {
                    answerText.innerHTML = `<strong>Answer:</strong> ${data.last_answer}`;
                    successAlert.style.display = "block";
                    // set the background of the answer to light green
                    answerText.style.backgroundColor = "#d4edda";
                }
            })
            .catch(error => {
                console.error("Error:", error);
                answerText.innerHTML = "<strong>Error:</strong> An error occurred.";
            })
            .finally(() => {
                // Reset progress bar and unlock input
                setTimeout(() => {
                    progressContainer.style.display = "none";
                    questionInput.disabled = false;
                    submitButton.disabled = false;
                    progressBar.style.width = "0%";
                    progressBar.setAttribute("aria-valuenow", 0);
                    progressBar.textContent = "0%";
                }, 1000);
            });
        });
        
        // Reset progress bar on page load
        window.addEventListener("pageshow", function() {
            successAlert.style.display = "none";
            errorAlert.style.display = "none";
            progressContainer.style.display = "none";
            questionInput.disabled = false;
            submitButton.disabled = false;
            progressBar.style.width = "0%";
            progressBar.setAttribute("aria-valuenow", 0);
            progressBar.textContent = "0%";
        });
    });
</script>



{% endblock %}
